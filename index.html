<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="logo.png" type="image/png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- NOTE: Phosphor Icons contains ph-spinner-gap and ph-paper-plane-tilt icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>

    <style>
        :root {
            --accent-color: #06b6d4; /* cyan-500 */
            --accent-color-hover: #0891b2; /* cyan-600 */

            /* --- Theme Variables --- */
            --bg-color: #0f172a; /* slate-900 */
            --text-color: #ffffff;
            --text-muted-color: #cbd5e1; /* slate-300 */
            --panel-bg: rgba(30, 41, 59, 0.3);
            --panel-border: rgba(255, 255, 255, 0.18);
            --input-bg: rgba(0, 0, 0, 0.3);
            --input-border: rgba(255, 255, 255, 0.2);
            --flip-card-top-bg: #2c3e50;
            --flip-card-bottom-bg: #34495e;
            --flip-card-border: rgba(0,0,0,0.4);
            --logo-color: #ffffff;
        }

        body.theme-light {
            --bg-color: #f1f5f9; /* slate-100 */
            --text-color: #1e293b; /* slate-800 */
            --text-muted-color: #475569; /* slate-600 */
            --panel-bg: rgba(255, 255, 255, 0.6);
            --panel-border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(0, 0, 0, 0.05);
            --input-border: rgba(0, 0, 0, 0.15);
            --flip-card-top-bg: #e2e8f0; /* slate-200 */
            --flip-card-bottom-bg: #f1f5f9; /* slate-100 */
            --flip-card-border: rgba(0,0,0,0.1);
            --logo-color: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out, background-image 0.5s ease-in-out;
        }

        /* Glassmorphism style for widgets */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1rem;
            border: 1px solid var(--panel-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

        .styled-input {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-color);
        }
        .styled-input::placeholder { color: var(--text-muted-color); opacity: 0.7; }

        .task-item { background: rgba(255, 255, 255, 0.05); transition: background 0.2s ease; }
        .task-item:hover { background: rgba(255, 255, 255, 0.1); }
        .theme-light .task-item { background: rgba(0,0,0, 0.03); }
        .theme-light .task-item:hover { background: rgba(0,0,0, 0.06); }
        .task-item .delete-btn { opacity: 0; transition: opacity 0.2s ease; }
        .task-item:hover .delete-btn { opacity: 1; }

        /* Clock Pulse Animation */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .clock-pulse { animation: pulse 0.4s ease-in-out; }

        /* --- Flip Clock Styles --- */
        .flip-clock { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .flip-unit { position: relative; width: 70px; height: 100px; perspective: 600px; font-size: 5rem; font-weight: bold; line-height: 100px; font-family: 'Inter', sans-serif; }
        @media (max-width: 768px) { .flip-unit { width: 45px; height: 60px; font-size: 2.5rem; line-height: 60px; } .flip-clock { gap: 5px; } }
        .flip-card { position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; }
        .flip-card-face { position: absolute; width: 100%; height: 50%; backface-visibility: hidden; -webkit-backface-visibility: hidden; overflow: hidden; border-radius: 8px; color: var(--text-color); text-align: center; }
        .flip-card-face.top { top: 0; line-height: 100px; background: var(--flip-card-top-bg); border-bottom: 1px solid var(--flip-card-border); }
        .flip-card-face.bottom { bottom: 0; line-height: 0; background: var(--flip-card-bottom-bg); }
        .flipper { z-index: 10; }
        .flipper.top-flipper { transform-origin: bottom; animation: flip-top 0.6s ease-in forwards; }
        @keyframes flip-top { from { transform: rotateX(0deg); } to { transform: rotateX(-90deg); } }
        /* --- End Flip Clock Styles --- */
        
        /* Accent color styling */
        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color); color: white; }
        .accent-bg-hover:hover { background-color: var(--accent-color-hover); }
        .accent-border { border-color: var(--accent-color); }
        .selection-accent::selection { background-color: var(--accent-color); color: #0f172a; }

        /* Settings Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: var(--accent-color); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--accent-color); }

        /* --- AI Chat & Doc Viewer Styles --- */
        .chat-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 80%; line-height: 1.5; word-wrap: break-word; }
        .chat-bubble-user { background-color: var(--accent-color); color: white; border-bottom-right-radius: 0.25rem; }
        .chat-bubble-ai { background-color: rgba(0,0,0,0.3); border-bottom-left-radius: 0.25rem; }
        .theme-light .chat-bubble-ai { background-color: rgba(0,0,0,0.08); }
        #doc-viewer-panel canvas { max-width: 100%; margin: 0 auto 1rem auto; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .ai-mode-btn { background-color: var(--input-bg); border: 1px solid var(--input-border); padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; transition: background-color 0.2s, border-color 0.2s; }
        .ai-mode-btn.accent-bg { border-color: var(--accent-color); }

        /* --- NEW: Typing Indicator Animation Styles (Bouncing Dots) --- */
       @keyframes bouncing-dot {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-8px); } /* Bounce height */
}
        .typing-indicator {
    display: flex;
    align-items: center;
    gap: 4px; /* Space between dots */
    height: 1.5rem; /* Ensure bubble doesn't collapse */
}

        .typing-indicator > div {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--text-color); /* Dots should use the text color */
    animation: bouncing-dot 1.2s infinite;
}

       .typing-indicator > div:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator > div:nth-child(3) {
    animation-delay: 0.4s;
}
.theme-light .typing-indicator > div {
     background-color: var(--text-color); /* Explicitly set for light mode */
}
        /* --- END NEW TYPING INDICATOR STYLES --- */

        /* --- Panel Open Animation --- */
        body.panel-open-shift #main-widget-grid {
             opacity: 0;
             pointer-events: none;
             transform: scale(0.95);
        }

        /* --- Minimized Widget Styles --- */
        #side-widget-container .glass-panel { padding: 0.75rem; }
        #side-widget-container h1, #side-widget-container p { text-align: center; }
        #side-widget-container #time-display-normal { font-size: 2.25rem; line-height: 2.5rem; }
        #side-widget-container #date-display { font-size: 0.75rem; line-height: 1rem; margin-top: 0.25rem; }
        #side-widget-container .flip-unit { width: 30px; height: 40px; font-size: 1.5rem; line-height: 40px; }
        #side-widget-container .flip-card-face.top { line-height: 40px; }
        #side-widget-container .flip-clock { gap: 4px; }
        #side-widget-container .flip-clock .text-5xl { font-size: 1.5rem; }
        #side-widget-container #timer-widget .flex-wrap { gap: 0.25rem; }
        #side-widget-container #timer-widget input { width: 40px; height: 40px; font-size: 1.125rem; }
        #side-widget-container #timer-widget .text-2xl, #side-widget-container #timer-widget .text-4xl { font-size: 1.125rem; }
        #side-widget-container #pomodoro-time, #side-widget-container #stopwatch-time { font-size: 2rem; line-height: 2.25rem; margin-bottom: 0.5rem; }
        #side-widget-container .timer-tab { padding-bottom: 0.25rem; font-size: 0.875rem; }
        #side-widget-container .flex-wrap button { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        #side-widget-container .flex-wrap button .ph { display: none; } /* Hide icons on small buttons */

        /* --- Focus & Enlarged Mode Styles --- */
        #focus-overlay {
            transition: opacity 0.5s ease-in-out;
            background: rgba(15, 23, 42, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
        }
        body.theme-light #focus-overlay { background: rgba(241, 245, 249, 0.3); }

        body.focus-active #focus-overlay,
        body.widget-enlarged #focus-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        body.focus-active #main-widget-grid > *,
        body.focus-active .bottom-right-controls,
        body.focus-active .top-left-logo { display: none; }
        
        body.focus-active #main-widget-grid {
            display: flex;
            flex-direction: column; /* Mobile first: stacked */
            justify-content: center;
            align-items: center;
            height: 100vh;
            gap: 2rem;
            padding: 1rem; /* Add padding for spacing from edges */
        }
        
        body.focus-active #clock-widget-wrapper,
        body.focus-active #timer-widget-wrapper {
            display: block;
            width: 90%; /* Occupy most width on mobile */
            max-width: 500px; /* Cap width on mobile */
            position: relative;
            z-index: 45;
            transform: scale(1.05);
        }

        /* On larger screens, switch to the requested row layout */
        @media (min-width: 1024px) {
            body.focus-active #main-widget-grid {
                flex-direction: row; /* Side-by-side */
                align-items: stretch; /* Make children same height */
            }
            body.focus-active #clock-widget-wrapper,
            body.focus-active #timer-widget-wrapper {
                width: 45%; /* Each takes up a bit less than half to allow for the gap */
                max-width: 700px; /* Allow them to grow larger */
            }
        }

        body.widget-enlarged #main-widget-grid > *,
        body.widget-enlarged .bottom-right-controls,
        body.widget-enlarged .top-left-logo {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .widget-is-enlarged {
            opacity: 1 !important;
            pointer-events: auto !important;
            position: fixed !important;
            width: 90vw;
            max-width: 800px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1.15);
            z-index: 55;
        }
        
        /* Appearance change for enlarged widgets */
        .widget-is-enlarged #clock-widget { padding: 2rem; }
        .widget-is-enlarged #time-display-normal { font-size: 10rem; }
        .widget-is-enlarged #date-display { font-size: 1.5rem; }
        .widget-is-enlarged .flip-unit { width: 90px; height: 120px; font-size: 6rem; line-height: 120px; }
        .widget-is-enlarged .flip-card-face.top { line-height: 120px; }

        .widget-is-enlarged #timer-widget { padding: 2rem; }
        .widget-is-enlarged #timer-widget input { width: 100px; height: 100px; font-size: 4rem; }
        .widget-is-enlarged #timer-widget .text-4xl { font-size: 4rem; }
        .widget-is-enlarged #pomodoro-time, .widget-is-enlarged #stopwatch-time { font-size: 8rem; }
        .widget-is-enlarged #pomodoro-status { font-size: 2rem; }
        .widget-is-enlarged .flex-wrap button { padding: 0.75rem 1.5rem; font-size: 1.125rem; }
        .widget-is-enlarged .timer-tab { font-size: 1.125rem; }

    </style>
</head>
<body class="selection-accent">
    <div id="focus-overlay" class="fixed inset-0 z-40"></div>

    <div class="fixed top-4 left-4 md:top-6 md:left-6 z-50 flex items-center gap-3 top-left-logo">
       <img src="logo.png" alt="Studi Logo" class="h-12 w-12 md:h-16 md:w-16 rounded-full object-cover">
    </div>

    <!-- Container for minimized widgets on the right -->
    <div id="side-widget-container" class="fixed top-4 right-4 z-[65] w-[300px] lg:w-[350px] space-y-4 transition-transform duration-500 ease-in-out transform translate-x-[400px]">
        <!-- Minimized clock and timer will be moved here by JS -->
    </div>

    <main class="min-h-screen w-full p-4 md:p-6 flex items-center justify-center">
        <div id="main-widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 w-full max-w-7xl transition-all duration-500 ease-in-out">

            <div id="clock-widget-wrapper" class="md:col-span-2 lg:col-span-2 relative">
                <button class="enlarge-widget-btn absolute top-3 right-3 p-2 rounded-full hover:bg-slate-500/50 transition-colors z-10" title="Enlarge Widget">
                    <i class="ph-bold ph-arrows-out text-lg"></i>
                </button>
                <div id="clock-widget" class="glass-panel p-4 md:p-6 flex flex-col justify-center items-center h-full">
                    <div id="time-display-container" class="w-full">
                         <h1 id="time-display-normal" class="text-5xl sm:text-6xl md:text-8xl font-bold tracking-tight flex items-baseline justify-center">00:00:00</h1>
                    </div>
                    <p id="date-display" class="text-sm text-center md:text-xl mt-2" style="color: var(--text-muted-color);">Thursday, 25 September 2025</p>
                </div>
            </div>

            <div id="timer-widget-wrapper" class="md:col-span-2 lg:col-span-2 relative">
                 <button class="enlarge-widget-btn absolute top-3 right-3 p-2 rounded-full hover:bg-slate-500/50 transition-colors z-10" title="Enlarge Widget">
                    <i class="ph-bold ph-arrows-out text-lg"></i>
                </button>
                <div id="timer-widget" class="glass-panel widget-in-focus p-4 md:p-6 h-full">
                    <div class="flex border-b mb-4" style="border-color: rgba(128,128,128, 0.2)">
                        <button id="countdown-tab" class="timer-tab flex-1 pb-2 text-sm sm:text-base border-b-2 accent-border accent-text font-semibold">Countdown</button>
                        <button id="pomodoro-tab" class="timer-tab flex-1 pb-2 text-sm sm:text-base border-b-2 border-transparent font-semibold" style="color: var(--text-muted-color);">Pomodoro</button>
                        <button id="stopwatch-tab" class="timer-tab flex-1 pb-2 text-sm sm:text-base border-b-2 border-transparent font-semibold" style="color: var(--text-muted-color);">Stopwatch</button>
                    </div>
                    <div id="countdown-view">
                         <div class="flex justify-center items-center gap-1 sm:gap-2 md:gap-4 mb-4">
                            <input id="hours" type="number" min="0" placeholder="HH" class="styled-input w-16 h-16 text-2xl sm:w-20 sm:h-20 sm:text-4xl text-center rounded-lg"><span class="text-2xl sm:text-4xl">:</span>
                            <input id="minutes" type="number" min="0" max="59" placeholder="MM" class="styled-input w-16 h-16 text-2xl sm:w-20 sm:h-20 sm:text-4xl text-center rounded-lg"><span class="text-2xl sm:text-4xl">:</span>
                            <input id="seconds" type="number" min="0" max="59" placeholder="SS" class="styled-input w-16 h-16 text-2xl sm:w-20 sm:h-20 sm:text-4xl text-center rounded-lg">
                        </div>
                        <div class="flex flex-wrap justify-center gap-2">
                            <button id="start-timer" class="accent-bg accent-bg-hover transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-play"></i> Start</button>
                            <button id="pause-timer" class="bg-slate-600 hover:bg-slate-700 transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-pause"></i> Pause</button>
                            <button id="reset-timer" class="bg-rose-600 hover:bg-rose-700 transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-arrow-counter-clockwise"></i> Reset</button>
                        </div>
                    </div>
                    <div id="pomodoro-view" class="hidden text-center">
                        <p id="pomodoro-status" class="text-xl sm:text-2xl font-semibold mb-2 accent-text">Focus</p>
                        <p id="pomodoro-time" class="text-6xl md:text-7xl font-bold mb-4">25:00</p>
                         <div class="flex flex-wrap justify-center gap-2">
                            <button id="pomodoro-start" class="accent-bg accent-bg-hover transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-play"></i> Start</button>
                             <button id="pomodoro-pause" class="bg-slate-600 hover:bg-slate-700 transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-pause"></i> Pause</button>
                            <button id="pomodoro-reset" class="bg-rose-600 hover:bg-rose-700 transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-skip-forward"></i> Skip</button>
                        </div>
                    </div>
                    <div id="stopwatch-view" class="hidden text-center">
                        <p id="stopwatch-time" class="text-5xl sm:text-6xl md:text-7xl font-bold font-mono mb-4 tracking-tight">00:00:00</p>
                        <div class="flex flex-wrap justify-center gap-2">
                            <button id="stopwatch-start" class="accent-bg accent-bg-hover transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-play"></i> Start</button>
                            <button id="stopwatch-pause" class="bg-slate-600 hover:bg-slate-700 transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-pause"></i> Pause</button>
                            <button id="stopwatch-reset" class="bg-rose-600 hover:bg-rose-700 transition-colors px-4 py-2 sm:px-6 rounded-lg font-semibold flex items-center gap-2"><i class="ph ph-arrow-counter-clockwise"></i> Reset</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tasks-widget" class="glass-panel widget-in-focus p-4 md:p-6 flex flex-col md:col-span-2 lg:col-span-2 min-h-[250px]">
                <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: rgba(128,128,128, 0.2)">
                    <h2 class="text-lg sm:text-xl font-bold">Quick Tasks</h2>
                    <button id="share-tasks-btn" title="Share Tasks" class="p-2 rounded-full hover:bg-slate-500/50 transition-colors"><i class="ph-bold ph-share-network text-xl"></i></button>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="task-input" class="styled-input w-full px-3 py-2 rounded-lg text-sm sm:text-base" placeholder="Add a new task...">
                    <button id="add-task-btn" class="accent-bg accent-bg-hover transition-colors px-4 py-2 rounded-lg font-semibold"><i class="ph ph-plus"></i></button>
                </div>
                <ul id="task-list" class="space-y-2 overflow-y-auto flex-grow"></ul>
            </div>
            
            <div id="music-widget" class="glass-panel non-focus-widget p-4 md:p-6 md:col-span-1 lg:col-span-1 flex flex-col">
                <h3 class="text-lg sm:text-xl font-bold mb-4 flex items-center gap-2"><i class="ph-bold ph-music-notes accent-text"></i> Music</h3>
                <div id="music-player-container" class="flex-grow flex flex-col justify-center">
                    <div class="flex gap-2">
                        <input type="text" id="music-url-input" class="styled-input w-full px-3 py-2 rounded-lg text-sm" placeholder="Paste music URL...">
                        <button id="load-music-btn" class="accent-bg accent-bg-hover transition-colors px-4 py-2 rounded-lg font-semibold"><i class="ph ph-arrow-right"></i></button>
                    </div>
                </div>
            </div>

            <div id="bg-changer-widget" class="glass-panel non-focus-widget p-4 md:p-6 md:col-span-1 lg:col-span-1 flex flex-col justify-between">
                 <h3 class="text-lg sm:text-xl font-bold mb-4 flex items-center gap-2"><i class="ph-bold ph-image accent-text"></i> Background</h3>
                 <div class="space-y-2">
                     <label for="bg-upload-input" class="w-full text-center block bg-slate-600 hover:bg-slate-700 transition-colors p-2 rounded-lg font-semibold cursor-pointer">
                        Upload Image
                    </label>
                    <input type="file" id="bg-upload-input" class="hidden" accept="image/*">
                    <button id="reset-bg-btn" class="w-full text-center block bg-slate-600 hover:bg-slate-700 transition-colors p-2 rounded-lg font-semibold cursor-pointer">
                        Reset Default
                    </button>
                 </div>
            </div>

            <div class="glass-panel non-focus-widget tools-widget p-4 md:p-6 md:col-span-2 flex flex-col justify-center text-center">
                <h3 class="text-lg sm:text-xl font-bold mb-4">Tools</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="open-ai-chat-btn" class="bg-slate-600 hover:bg-slate-700 transition-colors p-4 rounded-lg font-semibold flex flex-col items-center gap-2">
                        <i class="ph-bold ph-chats-circle text-4xl accent-text"></i>
                        <span>AI Assistant</span>
                    </button>
                    <button id="open-doc-viewer-btn" class="bg-slate-600 hover:bg-slate-700 transition-colors p-4 rounded-lg font-semibold flex flex-col items-center gap-2">
                        <i class="ph-bold ph-file-pdf text-4xl accent-text"></i>
                        <span>Doc Viewer</span>
                    </button>
                </div>
            </div>

        </div>
    </main>
    
    <button id="exit-focus-btn" class="hidden fixed top-4 right-4 md:top-6 md:right-6 z-50 accent-bg accent-bg-hover px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold text-base md:text-lg flex items-center gap-2" title="Exit Focus Mode">
        <i class="ph ph-x"></i> Exit Focus
    </button>
    <button id="exit-enlarged-btn" class="hidden fixed top-4 right-4 md:top-6 md:right-6 z-[60] accent-bg accent-bg-hover px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold text-base md:text-lg flex items-center gap-2" title="Go Back">
        <i class="ph ph-arrow-left"></i> Go Back
    </button>


    <div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 md:gap-3 bottom-right-controls">
        <button id="focus-mode-btn" class="glass-panel p-2 md:p-3 rounded-full hover:bg-slate-500/50 transition-colors" title="Toggle Focus Mode">
            <i class="ph-bold ph-crosshair text-xl md:text-2xl block leading-none"></i>
        </button>
        <button id="settings-btn" class="glass-panel p-2 md:p-3 rounded-full hover:bg-slate-500/50 transition-colors" title="Settings">
            <i class="ph-bold ph-gear text-xl md:text-2xl block leading-none"></i>
        </button>
        <button id="fullscreen-btn" class="glass-panel p-2 md:p-3 rounded-full hover:bg-slate-500/50 transition-colors" title="Toggle Fullscreen">
            <i id="fullscreen-icon" class="ph-bold ph-arrows-out text-xl md:text-2xl block leading-none"></i>
        </button>
    </div>

    <div id="settings-panel" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm sm:max-w-md p-6 rounded-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button id="close-settings-btn" class="p-1 rounded-full hover:bg-slate-500/50"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="space-y-6">
                <div>
                    <p class="font-semibold mb-3">Theme</p>
                    <div class="grid grid-cols-3 gap-3">
                        <button class="theme-btn border-2 p-2 rounded-lg font-semibold" data-theme="light">Light</button>
                        <button class="theme-btn border-2 p-2 rounded-lg font-semibold" data-theme="dark">Dark</button>
                        <button class="theme-btn border-2 p-2 rounded-lg font-semibold" data-theme="default-image">Image</button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label for="clock-format-toggle" class="font-semibold">24-Hour Clock</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="clock-format-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="clock-format-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
                 <div class="flex items-center justify-between">
                    <label for="clock-animation-select" class="font-semibold">Clock Style</label>
                    <select id="clock-animation-select" class="styled-input rounded-lg px-3 py-1.5">
                        <option value="normal">Normal</option>
                        <option value="pulse">Pulse</option>
                        <option value="flip">Flip</option>
                    </select>
                </div>
                 <div class="flex items-center justify-between">
                    <label for="timer-sound-select" class="font-semibold">Timer Alert Sound</label>
                    <select id="timer-sound-select" class="styled-input rounded-lg px-3 py-1.5">
                        <option value="C5">Default</option>
                        <option value="G5">High Pitch</option>
                        <option value="A4">Melody</option>
                    </select>
                </div>
                  <div class="flex items-center justify-between">
                    <p class="font-semibold">Accent Color</p>
                    <div class="flex gap-3">
                        <button class="color-swatch w-8 h-8 rounded-full bg-cyan-500" data-color="cyan"></button>
                        <button class="color-swatch w-8 h-8 rounded-full bg-fuchsia-500" data-color="fuchsia"></button>
                        <button class="color-swatch w-8 h-8 rounded-full bg-lime-500" data-color="lime"></button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label for="stopwatch-ms-toggle" class="font-semibold">Show Milliseconds</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="stopwatch-ms-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="stopwatch-ms-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="share-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 rounded-2xl text-center">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Share Your Tasks</h2>
                <button id="close-share-btn" class="p-1 rounded-full hover:bg-slate-500/50"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <p class="mb-4" style="color: var(--text-muted-color);">Share this link or QR code with others.</p>
            <div id="qrcode" class="flex justify-center mb-4 p-2 bg-white rounded-lg"></div>
            <input id="share-link-input" type="text" readonly class="styled-input w-full text-center p-2 rounded-lg mb-4">
            <button id="copy-link-btn" class="w-full accent-bg accent-bg-hover transition-colors px-6 py-2 rounded-lg font-semibold flex items-center justify-center gap-2">
                <i class="ph ph-copy"></i><span>Copy Link</span>
            </button>
        </div>
    </div>

    <div id="ai-chat-panel" class="hidden fixed top-0 left-0 h-full w-full md:w-3/4 z-[60] transform -translate-x-full transition-transform duration-500 ease-in-out">
    <div class="glass-panel w-full h-full flex flex-col p-4 md:p-6 rounded-none md:rounded-r-2xl md:rounded-l-none">
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
            <h2 class="text-2xl font-bold flex items-center gap-2"><i class="ph-bold ph-chats-circle accent-text"></i> AI Assistant</h2>
            <button id="close-ai-chat-btn" class="p-1 rounded-full hover:bg-slate-500/50"><i class="ph-bold ph-x text-xl"></i></button>
        </div>
        <div id="ai-chat-messages" class="flex-grow bg-black/20 rounded-lg p-4 mb-4 overflow-y-auto flex flex-col gap-4">
        </div>
        <span class="typing-indicator">
            <div></div>
            <div></div>
            <div></div>
        </span>
        <div class="flex-shrink-0 mb-3">
            <p class="text-sm mb-2" style="color: var(--text-muted-color);">Select AI Mode:</p>
            <div class="flex flex-wrap gap-2">
                <button class="ai-mode-btn accent-bg" data-mode="General">General</button>
                <button class="ai-mode-btn" data-mode="DeepStudy">Deep Study</button>
                <button class="ai-mode-btn" data-mode="Productivity">Productivity Coach</button>
                <button class="ai-mode-btn" data-mode="CodeMentor">Code Mentor</button>
                <button class="ai-mode-btn" data-mode="DoubtSolving">Doubt Solving</button>
            </div>
        </div>
        <div class="flex gap-2 flex-shrink-0">
            <input id="ai-chat-input" type="text" placeholder="Ask anything..." class="styled-input w-full p-3 rounded-lg">
            <button id="ai-chat-send" class="accent-bg accent-bg-hover p-3 rounded-lg"><i class="ph-bold ph-paper-plane-tilt text-2xl"></i></button>
        </div>
    </div>
</div>

    <div id="doc-viewer-panel" class="hidden fixed top-0 left-0 h-full w-full md:w-3/4 z-[60] transform -translate-x-full transition-transform duration-500 ease-in-out">
        <div class="glass-panel w-full h-full flex flex-col p-4 md:p-6 rounded-none md:rounded-r-2xl md:rounded-l-none">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold flex items-center gap-2"><i class="ph-bold ph-file-pdf accent-text"></i> Document Viewer</h2>
                <div class="flex items-center gap-4">
                    <button id="change-file-btn" class="hidden accent-bg accent-bg-hover text-sm px-3 py-1.5 rounded-lg font-semibold">Change File</button>
                    <button id="close-doc-viewer-btn" class="p-1 rounded-full hover:bg-slate-500/50"><i class="ph-bold ph-x text-xl"></i></button>
                </div>
            </div>
            <div id="viewer-container" class="flex-grow bg-black/20 rounded-lg p-4 overflow-y-auto">
                <div class="h-full flex flex-col items-center justify-center text-center">
                    <i class="ph-bold ph-file-arrow-up text-6xl mb-4" style="color: var(--text-muted-color);"></i>
                    <p style="color: var(--text-muted-color);">Select a PDF or Image file to view.</p>
                    <label for="file-viewer-input" class="mt-6 cursor-pointer accent-bg accent-bg-hover px-6 py-3 rounded-lg font-semibold">Select File</label>
                    <input type="file" id="file-viewer-input" class="hidden" accept="application/pdf,image/*">
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL SETTINGS & STATE ---
            let currentAiMode = 'General';
            const settings = {
                is24Hour: localStorage.getItem('studi-is24Hour') === 'true',
                timerSound: localStorage.getItem('studi-timerSound') || 'C5',
                accentColor: localStorage.getItem('studi-accentColor') || 'cyan',
                clockStyle: localStorage.getItem('studi-clockStyle') || 'normal',
                showMilliseconds: localStorage.getItem('studi-showMilliseconds') === 'true',
                theme: localStorage.getItem('studi-theme') || 'default-image',
                focusMode: false,
            };
            const root = document.documentElement;
            const colors = {
                cyan: { accent: '#06b6d4', hover: '#0891b2' },
                fuchsia: { accent: '#d946ef', hover: '#c026d3' },
                lime: { accent: '#84cc16', hover: '#65a30d' },
            };
            const defaultBgImage = "url('https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80')";


            function applyTheme() {
                document.body.classList.remove('theme-light');
                document.body.style.backgroundImage = '';

                if (settings.theme === 'light') {
                    document.body.classList.add('theme-light');
                } else if (settings.theme === 'dark') {
                    // Dark is default state, no class needed, just ensure no image.
                } else if (settings.theme === 'default-image') {
                    document.body.style.backgroundImage = defaultBgImage;
                } else if (settings.theme.startsWith('data:image')) { // Custom uploaded image
                    document.body.style.backgroundImage = `url('${settings.theme}')`;
                }

                // Update active button state
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    const isDefaultImage = settings.theme === 'default-image' || settings.theme.startsWith('data:image');
                    let isActive;
                    if (btn.dataset.theme === 'default-image') {
                        isActive = isDefaultImage;
                    } else {
                        isActive = btn.dataset.theme === settings.theme;
                    }

                    btn.classList.toggle('accent-bg', isActive);
                    btn.classList.toggle('accent-border', isActive);
                    btn.classList.toggle('border-transparent', !isActive);
                });
            }


            function applySettings() {
                // Apply color
                root.style.setProperty('--accent-color', colors[settings.accentColor].accent);
                root.style.setProperty('--accent-color-hover', colors[settings.accentColor].hover);
                document.querySelectorAll('.color-swatch').forEach(swatch => {
                    swatch.classList.toggle('ring-2', swatch.dataset.color === settings.accentColor);
                    swatch.classList.toggle('ring-white', swatch.dataset.color === settings.accentColor);
                });

                // Apply toggles
                document.getElementById('clock-format-toggle').checked = settings.is24Hour;
                document.getElementById('stopwatch-ms-toggle').checked = settings.showMilliseconds;
                
                // Apply selects
                document.getElementById('clock-animation-select').value = settings.clockStyle;
                document.getElementById('timer-sound-select').value = settings.timerSound;
                
                // Apply theme
                applyTheme();
                
                // Setup clock style
                setupClockView(settings.clockStyle);
            }

            // --- WIDGET 1: CLOCK & DATE ---
            const timeDisplayContainer = document.getElementById('time-display-container');
            const dateDisplay = document.getElementById('date-display');
            let clockInterval;

            function setupClockView(style) {
                clearInterval(clockInterval);
                timeDisplayContainer.innerHTML = '';
                
                if (style === 'flip') {
                    timeDisplayContainer.innerHTML = `
                        <div class="flip-clock">
                            <div class="flip-unit"><div class="flip-card" data-unit="hours" data-index="0"></div></div>
                            <div class="flip-unit"><div class="flip-card" data-unit="hours" data-index="1"></div></div>
                            <div class="text-5xl self-center">:</div>
                            <div class="flip-unit"><div class="flip-card" data-unit="minutes" data-index="0"></div></div>
                            <div class="flip-unit"><div class="flip-card" data-unit="minutes" data-index="1"></div></div>
                            <div class="text-5xl self-center">:</div>
                            <div class="flip-unit"><div class="flip-card" data-unit="seconds" data-index="0"></div></div>
                            <div class="flip-unit"><div class="flip-card" data-unit="seconds" data-index="1"></div></div>
                        </div>`;
                    initFlipClock();
                    clockInterval = setInterval(updateFlipClock, 1000);
                } else {
                    timeDisplayContainer.innerHTML = `<h1 id="time-display-normal" class="text-5xl sm:text-6xl md:text-8xl font-bold tracking-tight flex items-baseline justify-center">00:00:00</h1>`;
                    updateNormalClock(); // Update immediately
                    clockInterval = setInterval(updateNormalClock, 1000);
                }
            }

            function updateNormalClock() {
                const timeDisplay = document.getElementById('time-display-normal');
                if (!timeDisplay) return;

                const now = new Date();
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: !settings.is24Hour };
                let timeString = now.toLocaleTimeString('en-US', timeOptions);

                if (settings.is24Hour) {
                    timeDisplay.innerHTML = timeString.split(' ')[0];
                } else {
                    const parts = timeString.split(' ');
                    timeDisplay.innerHTML = `${parts[0]} <span class="text-2xl sm:text-3xl md:text-5xl font-medium tracking-normal" style="color: var(--text-muted-color);">${parts[1]}</span>`;
                }
                
                if (settings.clockStyle === 'pulse' && !timeDisplay.classList.contains('clock-pulse')) {
                    timeDisplay.classList.add('clock-pulse');
                    setTimeout(() => timeDisplay.classList.remove('clock-pulse'), 400);
                }
                dateDisplay.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }

            function initFlipClock() {
                const now = new Date();
                const hours = settings.is24Hour ? now.getHours() : now.getHours() % 12 || 12;
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();
                const timeValues = {
                    hours: hours.toString().padStart(2,'0'),
                    minutes: minutes.toString().padStart(2,'0'),
                    seconds: seconds.toString().padStart(2,'0')
                };

                for (const unit in timeValues) {
                    const digits = timeValues[unit];
                    for(let i=0; i < digits.length; i++) {
                        const card = document.querySelector(`.flip-card[data-unit="${unit}"][data-index="${i}"]`);
                        if (card) {
                            const digit = digits[i];
                            card.innerHTML = `
                                <div class="flip-card-face top static" data-value="${digit}">${digit}</div>
                                <div class="flip-card-face bottom static" data-value="${digit}">${digit}</div>`;
                        }
                    }
                }
            }
            
            function updateFlipClock() {
                const now = new Date();
                const hours = settings.is24Hour ? now.getHours() : now.getHours() % 12 || 12;
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();
                const timeValues = {
                    hours: hours.toString().padStart(2,'0'),
                    minutes: minutes.toString().padStart(2,'0'),
                    seconds: seconds.toString().padStart(2,'0')
                };

                for (const unit in timeValues) {
                    const digits = timeValues[unit];
                    for(let i=0; i < digits.length; i++) {
                        const card = document.querySelector(`.flip-card[data-unit="${unit}"][data-index="${i}"]`);
                        if(card) {
                            const newValue = digits[i];
                            flip(card, newValue);
                        }
                    }
                }
                 dateDisplay.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }

            function flip(card, newValue) {
                const staticTop = card.querySelector('.top.static');
                const staticBottom = card.querySelector('.bottom.static');
                const currentValue = staticTop.dataset.value;

                if (currentValue === newValue || card.querySelector('.flipper.top-flipper')) return;

                const topFlipper = document.createElement('div');
                topFlipper.className = 'flip-card-face top flipper top-flipper';
                topFlipper.textContent = currentValue;
                
                staticTop.textContent = newValue;
                staticTop.dataset.value = newValue;

                card.append(topFlipper);

                setTimeout(() => {
                    staticBottom.textContent = newValue;
                    staticBottom.dataset.value = newValue;
                    topFlipper.remove();
                }, 600);
            }
            
            // --- WIDGET 2: TIMERS ---
            const timerTabs = document.querySelectorAll('.timer-tab');
            const timerViews = {
                countdown: document.getElementById('countdown-view'),
                pomodoro: document.getElementById('pomodoro-view'),
                stopwatch: document.getElementById('stopwatch-view')
            };

            function switchTimerTab(selectedId) {
                timerTabs.forEach(tab => {
                    const isSelected = tab.id === selectedId;
                    tab.classList.toggle('accent-border', isSelected);
                    tab.classList.toggle('accent-text', isSelected);
                    tab.classList.toggle('border-transparent', !isSelected);
                    tab.style.color = isSelected ? 'var(--accent-color)' : 'var(--text-muted-color)';
                    timerViews[tab.id.replace('-tab', '')].classList.toggle('hidden', !isSelected);
                });
            }
            timerTabs.forEach(tab => tab.addEventListener('click', () => switchTimerTab(tab.id)));
            
            let synth;
            function initializeSynth() { if (!synth && window.Tone) { if (Tone.context.state !== 'running') Tone.start(); synth = new Tone.Synth().toDestination(); } }
            document.body.addEventListener('click', initializeSynth, { once: true });
            
            function playTimerSound() {
                if(synth) {
                    if (settings.timerSound === 'A4') {
                        const now = Tone.now();
                        synth.triggerAttackRelease("A4", "8n", now);
                        synth.triggerAttackRelease("E5", "8n", now + 0.25);
                        synth.triggerAttackRelease("A5", "8n", now + 0.5);
                    } else {
                        synth.triggerAttackRelease(settings.timerSound, "0.5");
                    }
                }
            }
            // Countdown Logic
            const hoursInput = document.getElementById('hours'); const minutesInput = document.getElementById('minutes'); const secondsInput = document.getElementById('seconds');
            let countdownInterval, totalSeconds = 0, isPaused = false;
            document.getElementById('start-timer').addEventListener('click', () => { if(totalSeconds <= 0){ const h = parseInt(hoursInput.value) || 0, m = parseInt(minutesInput.value) || 0, s = parseInt(secondsInput.value) || 0; totalSeconds = (h * 3600) + (m * 60) + s; } if (totalSeconds > 0) { isPaused = false; startCountdown(); } });
            document.getElementById('pause-timer').addEventListener('click', () => { isPaused = true; clearInterval(countdownInterval); });
            document.getElementById('reset-timer').addEventListener('click', () => { clearInterval(countdownInterval); totalSeconds = 0; isPaused = false; hoursInput.value = ''; minutesInput.value = ''; secondsInput.value = ''; updateCountdownDisplay(); });
            function startCountdown() { clearInterval(countdownInterval); countdownInterval = setInterval(() => { if (totalSeconds > 0 && !isPaused) { totalSeconds--; updateCountdownDisplay(); } else if (totalSeconds <= 0) { clearInterval(countdownInterval); playTimerSound(); setTimeout(() => { hoursInput.value = ''; minutesInput.value = ''; secondsInput.value = ''; }, 1000); } }, 1000); }
            function updateCountdownDisplay() { const h = Math.floor(totalSeconds / 3600), m = Math.floor((totalSeconds % 3600) / 60), s = totalSeconds % 60; hoursInput.value = h.toString().padStart(2, '0'); minutesInput.value = m.toString().padStart(2, '0'); secondsInput.value = s.toString().padStart(2, '0'); }
            
            // Pomodoro Logic
            const pomodoroStatus = document.getElementById('pomodoro-status'); const pomodoroTime = document.getElementById('pomodoro-time');
            let pomodoroInterval; let pomodoroState = { mode: 'focus', timeLeft: 1500, cycles: 0, isRunning: false }; const pomodoroTimes = { focus: 1500, shortBreak: 300, longBreak: 900 };
            document.getElementById('pomodoro-start').addEventListener('click', () => { pomodoroState.isRunning = true; startPomodoro(); });
            document.getElementById('pomodoro-pause').addEventListener('click', () => { pomodoroState.isRunning = false; clearInterval(pomodoroInterval); });
            document.getElementById('pomodoro-reset').addEventListener('click', () => { clearInterval(pomodoroInterval); switchPomodoroMode(); if (pomodoroState.isRunning) startPomodoro(); });
            function startPomodoro() { clearInterval(pomodoroInterval); pomodoroInterval = setInterval(() => { if (pomodoroState.timeLeft > 0 && pomodoroState.isRunning) { pomodoroState.timeLeft--; updatePomodoroDisplay(); } else if (pomodoroState.timeLeft <= 0) { clearInterval(pomodoroInterval); playTimerSound(); switchPomodoroMode(); startPomodoro(); } }, 1000); }
            function switchPomodoroMode() { if (pomodoroState.mode === 'focus') { pomodoroState.cycles++; if (pomodoroState.cycles % 4 === 0) { pomodoroState.mode = 'longBreak'; pomodoroStatus.textContent = "Long Break"; pomodoroState.timeLeft = pomodoroTimes.longBreak; } else { pomodoroState.mode = 'shortBreak'; pomodoroStatus.textContent = "Short Break"; pomodoroState.timeLeft = pomodoroTimes.shortBreak; } } else { pomodoroState.mode = 'focus'; pomodoroStatus.textContent = "Focus"; pomodoroState.timeLeft = pomodoroTimes.focus; } updatePomodoroDisplay(); }
            function updatePomodoroDisplay() { const m = Math.floor(pomodoroState.timeLeft / 60), s = pomodoroState.timeLeft % 60; pomodoroTime.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; }
            updatePomodoroDisplay();

            // Stopwatch Logic
            const stopwatchTime = document.getElementById('stopwatch-time');
            let stopwatchInterval, stopwatchStartTime, stopwatchElapsedTime = 0, stopwatchIsRunning = false;
            function updateStopwatchDisplay() {
                const totalMs = stopwatchElapsedTime;
                const hours = Math.floor(totalMs / 3600000);
                const minutes = Math.floor((totalMs % 3600000) / 60000);
                const seconds = Math.floor((totalMs % 60000) / 1000);
                let timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (settings.showMilliseconds) {
                    const centiseconds = Math.floor((totalMs % 1000) / 10);
                    timeString += `:${centiseconds.toString().padStart(2, '0')}`;
                }
                stopwatchTime.textContent = timeString;
            }
            document.getElementById('stopwatch-start').addEventListener('click', () => { if (!stopwatchIsRunning) { stopwatchIsRunning = true; stopwatchStartTime = Date.now() - stopwatchElapsedTime; stopwatchInterval = setInterval(() => { stopwatchElapsedTime = Date.now() - stopwatchStartTime; updateStopwatchDisplay(); }, 10); } });
            document.getElementById('stopwatch-pause').addEventListener('click', () => { stopwatchIsRunning = false; clearInterval(stopwatchInterval); });
            document.getElementById('stopwatch-reset').addEventListener('click', () => { stopwatchIsRunning = false; clearInterval(stopwatchInterval); stopwatchElapsedTime = 0; updateStopwatchDisplay(); });
            updateStopwatchDisplay();
            
            // --- QUICK TASKS WIDGET ---
            const taskInput = document.getElementById('task-input'); const addTaskBtn = document.getElementById('add-task-btn'); const taskList = document.getElementById('task-list');
            const addTask = (taskText) => { if (taskText.trim() === '') return; const li = document.createElement('li'); li.className = 'task-item flex items-center justify-between p-2 rounded-lg'; li.innerHTML = `<span class="flex-grow">${taskText}</span><button class="delete-btn text-rose-400 hover:text-rose-500 ml-2 p-1 rounded-full"><i class="ph-bold ph-trash"></i></button>`; li.querySelector('.delete-btn').addEventListener('click', () => { li.remove(); }); taskList.appendChild(li); };
            addTaskBtn.addEventListener('click', () => { addTask(taskInput.value); taskInput.value = ''; taskInput.focus(); });
            taskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { addTask(taskInput.value); taskInput.value = ''; } });
            
            // --- SHARE TASKS ---
            const shareModal = document.getElementById('share-modal');
            const qrCodeEl = document.getElementById('qrcode');
            const shareLinkInput = document.getElementById('share-link-input');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            let qrCodeInstance = null;
            document.getElementById('share-tasks-btn').addEventListener('click', () => {
                const tasks = [...taskList.querySelectorAll('li span')].map(span => span.textContent);
                if (tasks.length === 0) { return; } 
                const encodedTasks = encodeURIComponent(JSON.stringify(tasks));
                const url = `${window.location.origin}${window.location.pathname}?tasks=${encodedTasks}`;
                shareLinkInput.value = url;
                
                if (qrCodeInstance) {
                    qrCodeInstance.clear();
                    qrCodeInstance.makeCode(url);
                } else {
                    qrCodeInstance = new QRCode(qrCodeEl, { text: url, width: 128, height: 128, colorDark: "#000000", colorLight: "#ffffff" });
                }
                
                shareModal.classList.remove('hidden');
            });
            document.getElementById('close-share-btn').addEventListener('click', () => shareModal.classList.add('hidden'));
            copyLinkBtn.addEventListener('click', () => {
                shareLinkInput.select();
                document.execCommand('copy');
                const btnText = copyLinkBtn.querySelector('span');
                btnText.textContent = 'Copied!';
                setTimeout(() => { btnText.textContent = 'Copy Link'; }, 2000);
            });
            
            // Check for tasks in URL on load
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('tasks')) {
                try {
                    const tasks = JSON.parse(decodeURIComponent(urlParams.get('tasks')));
                    if (Array.isArray(tasks)) {
                        tasks.forEach(task => addTask(task));
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) {
                    console.error('Failed to parse tasks from URL', e);
                }
            }
            
            // --- FULLSCREEN TOGGLE ---
            const fullscreenBtn = document.getElementById('fullscreen-btn'); const fullscreenIcon = document.getElementById('fullscreen-icon');
            function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => { console.error(`Error: ${err.message}`); }); } else { if (document.exitFullscreen) { document.exitFullscreen(); } } }
            function updateFullscreenIcon() { if (document.fullscreenElement) { fullscreenIcon.classList.replace('ph-arrows-out', 'ph-arrows-in'); } else { fullscreenIcon.classList.replace('ph-arrows-in', 'ph-arrows-out'); } }
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            document.addEventListener('fullscreenchange', updateFullscreenIcon);

            // --- SETTINGS PANEL LOGIC ---
            const settingsBtn = document.getElementById('settings-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            
            settingsBtn.addEventListener('click', () => settingsPanel.classList.remove('hidden'));
            closeSettingsBtn.addEventListener('click', () => settingsPanel.classList.add('hidden'));

            // Theme Change
            document.querySelectorAll('.theme-btn').forEach(button => { button.addEventListener('click', () => { settings.theme = button.dataset.theme; localStorage.setItem('studi-theme', settings.theme); applyTheme(); }); });
            // Clock Format Change
            document.getElementById('clock-format-toggle').addEventListener('change', (e) => { settings.is24Hour = e.target.checked; localStorage.setItem('studi-is24Hour', settings.is24Hour); });
             // Sound Change
            document.getElementById('timer-sound-select').addEventListener('change', (e) => { settings.timerSound = e.target.value; localStorage.setItem('studi-timerSound', settings.timerSound); if (synth) synth.triggerAttackRelease(settings.timerSound, "0.5"); });
              // Color Change
            document.querySelectorAll('.color-swatch').forEach(button => { button.addEventListener('click', () => { settings.accentColor = button.dataset.color; localStorage.setItem('studi-accentColor', settings.accentColor); applySettings(); }); });
            // Clock Style Change
            document.getElementById('clock-animation-select').addEventListener('change', (e) => { settings.clockStyle = e.target.value; localStorage.setItem('studi-clockStyle', settings.clockStyle); setupClockView(settings.clockStyle); });
            // Stopwatch Milliseconds Change
            document.getElementById('stopwatch-ms-toggle').addEventListener('change', (e) => { settings.showMilliseconds = e.target.checked; localStorage.setItem('studi-showMilliseconds', settings.showMilliseconds); updateStopwatchDisplay(); });

            // --- FOCUS & ENLARGED MODE LOGIC ---
            const focusModeBtn = document.getElementById('focus-mode-btn');
            const exitFocusBtn = document.getElementById('exit-focus-btn');
            const enlargeWidgetBtns = document.querySelectorAll('.enlarge-widget-btn');
            const exitEnlargedBtn = document.getElementById('exit-enlarged-btn');
            
            function handleFocusToggle() {
                settings.focusMode = !settings.focusMode;
                document.body.classList.toggle('focus-active', settings.focusMode);
                exitFocusBtn.classList.toggle('hidden', !settings.focusMode);
            }

            enlargeWidgetBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const wrapper = e.currentTarget.closest('.md\\:col-span-2');
                    if (wrapper) {
                        document.body.classList.add('widget-enlarged');
                        wrapper.classList.add('widget-is-enlarged');
                        exitEnlargedBtn.classList.remove('hidden');
                    }
                });
            });

            exitEnlargedBtn.addEventListener('click', () => {
                document.body.classList.remove('widget-enlarged');
                const enlarged = document.querySelector('.widget-is-enlarged');
                if (enlarged) {
                    enlarged.classList.remove('widget-is-enlarged');
                }
                exitEnlargedBtn.classList.add('hidden');
            });

            focusModeBtn.addEventListener('click', handleFocusToggle);
            exitFocusBtn.addEventListener('click', handleFocusToggle);
            
            // --- AI & DOCS FEATURE LOGIC ---
            const aiChatPanel = document.getElementById('ai-chat-panel');
            const docViewerPanel = document.getElementById('doc-viewer-panel');
            const clockWidget = document.getElementById('clock-widget');
            const timerWidget = document.getElementById('timer-widget');
            const clockWidgetWrapper = document.getElementById('clock-widget-wrapper');
            const timerWidgetWrapper = document.getElementById('timer-widget-wrapper');
            const sideWidgetContainer = document.getElementById('side-widget-container');

            function openSidePanel(panel) {
                document.body.classList.add('panel-open-shift');
                sideWidgetContainer.appendChild(clockWidget);
                sideWidgetContainer.appendChild(timerWidget);
                
                sideWidgetContainer.classList.remove('translate-x-[400px]');
                panel.classList.remove('hidden');
                setTimeout(() => {
                    panel.classList.remove('-translate-x-full');
                }, 10); 
            }

            function closeSidePanel(panel) {
                document.body.classList.remove('panel-open-shift');
                
                sideWidgetContainer.classList.add('translate-x-[400px]');
                panel.classList.add('-translate-x-full');
                
                setTimeout(() => {
                    panel.classList.add('hidden');
                    clockWidgetWrapper.appendChild(clockWidget);
                    timerWidgetWrapper.appendChild(timerWidget);

                    if (panel.id === 'doc-viewer-panel') {
                        document.getElementById('change-file-btn').classList.add('hidden');
                    }
                }, 500); // Match transition duration
            }

            document.getElementById('open-ai-chat-btn').addEventListener('click', () => openSidePanel(aiChatPanel));
            document.getElementById('close-ai-chat-btn').addEventListener('click', () => closeSidePanel(aiChatPanel));
            document.getElementById('open-doc-viewer-btn').addEventListener('click', () => openSidePanel(docViewerPanel));
            document.getElementById('close-doc-viewer-btn').addEventListener('click', () => closeSidePanel(docViewerPanel));

            // AI Chat
            const aiChatInput = document.getElementById('ai-chat-input');
            const aiChatSendBtn = document.getElementById('ai-chat-send');
            const messagesContainer = document.getElementById('ai-chat-messages');
            const aiModeBtns = document.querySelectorAll('.ai-mode-btn');

            aiModeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    aiModeBtns.forEach(b => b.classList.remove('accent-bg'));
                    btn.classList.add('accent-bg');
                    currentAiMode = btn.dataset.mode;
                });
            });

            async function handleAIChat() {
    const message = aiChatInput.value.trim();
    if(!message) return;

    // FIX 1: Using a working model (gemini-1.5-pro or gemini-2.5-flash) to avoid 404 errors.
    // NOTE: Using a placeholder API key. User must replace it.
    const GEMINI_API_KEY = "AIzaSyBNlEqXOixt8pkkHt--ZfqzTd1beniqGl0"; 
    const modelName = "gemini-2.5-flash"; // FIX: Changed from potentially deprecated name

    // 1. Append the user's message
    messagesContainer.innerHTML += `<div class="w-full flex justify-end"><p class="chat-bubble chat-bubble-user">${message}</p></div>`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    aiChatInput.value = '';
    
    if (GEMINI_API_KEY === "") {
         messagesContainer.innerHTML += `<div class="w-full flex"><p class="chat-bubble chat-bubble-ai">Please add your Gemini API key to the script to enable the AI Assistant.</p></div>`;
         messagesContainer.scrollTop = messagesContainer.scrollHeight;
         return;
    }

    // 2. Append the animated typing indicator
    // This is the new part. Create a new element for the loading bubble.
    const aiLoadingBubble = document.createElement('div');
aiLoadingBubble.className = "w-full flex";
aiLoadingBubble.innerHTML = `
    <p class="chat-bubble chat-bubble-ai">
        <span class="typing-indicator">
            <div></div>
            <div></div>
            <div></div>
        </span>
    </p>
`;
messagesContainer.appendChild(aiLoadingBubble);
messagesContainer.scrollTop = messagesContainer.scrollHeight;

    const systemPrompts = {
        General: "You are Studi Assistant, a friendly and versatile productivity helper. Answer queries concisely and offer tips related to focus, study, or task management.",
        DeepStudy: "You are an expert tutor specializing in complex subjects. Provide detailed explanations, historical context, or advanced concepts. Your goal is in-depth, structured knowledge transfer.",
        Productivity: "You are a time management coach. Give advice, strategies, and motivation for improving focus, utilizing the Pomodoro Technique, or prioritizing tasks from the user's task list.",
        CodeMentor: "You are an expert programming mentor. Provide clean, efficient code and clear explanations of the logic. Offer advice on algorithms and best practices.",
        DoubtSolving: "You are a clear and concise problem solver. Directly address the user's specific question, clarify misconceptions, and provide only the most accurate answer without unnecessary detail."
    };

    const finalMessage = `${systemPrompts[currentAiMode]} Please answer the following query: ${message}`;
    
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: finalMessage }] }] })
        });
        
        if(!response.ok) {
             const errorData = await response.json();
             throw new Error(`API Error: ${errorData.error.message}`);
        }
        
        const data = await response.json();
        const aiMessage = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
        
        // 3. Replace the animated bubble with the AI's actual response
        // This is the new part. Update the content of the loading bubble.
        aiLoadingBubble.innerHTML = `<p class="chat-bubble chat-bubble-ai">${aiMessage}</p>`;

    } catch(error) {
        // Handle the error by updating the loading bubble with an error message
        aiLoadingBubble.innerHTML = `<p class="chat-bubble chat-bubble-ai">Sorry, there was an error: ${error.message}</p>`;
    } finally {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

            aiChatSendBtn.addEventListener('click', handleAIChat);
            aiChatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleAIChat() });

            // Document Viewer
            const fileViewerInput = document.getElementById('file-viewer-input');
            const changeFileBtn = document.getElementById('change-file-btn');
            fileViewerInput.addEventListener('change', handleFileSelect);
            changeFileBtn.addEventListener('click', () => fileViewerInput.click());

            function handleFileSelect(event) {
                const file = event.target.files[0];
                const viewerContainer = document.getElementById('viewer-container');
                if (!file) return;

                viewerContainer.innerHTML = `<div class="h-full flex items-center justify-center text-center"><i class="ph-bold ph-spinner-gap text-6xl animate-spin"></i><p class="mt-4">Loading...</p></div>`;
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        viewerContainer.innerHTML = `<img src="${e.target.result}" class="max-w-full h-full object-contain mx-auto">`; 
                        changeFileBtn.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
                            const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
                            viewerContainer.innerHTML = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale: 1.5 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                viewerContainer.appendChild(canvas);
                            }
                            changeFileBtn.classList.remove('hidden');
                        } catch (pdfError) {
                            viewerContainer.innerHTML = `<p class="text-rose-400">Error loading PDF: ${pdfError.message}</p>`;
                            changeFileBtn.classList.remove('hidden');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            }
            
            // --- MUSIC WIDGET LOGIC ---
            function setupMusicWidget() {
                const musicPlayerContainer = document.getElementById('music-player-container');
                const loadMusicBtn = document.getElementById('load-music-btn');
                const musicUrlInput = document.getElementById('music-url-input');

                if (loadMusicBtn) loadMusicBtn.addEventListener('click', loadMusic);
                if (musicUrlInput) musicUrlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') loadMusic(); });
            }

            function loadMusic() {
                const musicPlayerContainer = document.getElementById('music-player-container');
                const musicUrlInput = document.getElementById('music-url-input');
                const url = musicUrlInput.value.trim();
                if (!url) return;

                let embedUrl = '';
                if (url.includes('open.spotify.com')) {
                    const trackId = url.split('/track/')[1]?.split('?')[0];
                    if(trackId) embedUrl = `https://open.spotify.com/embed/track/${trackId}`;
                } else if (url.includes('music.youtube.com/watch?v=')) {
                    const videoId = new URL(url).searchParams.get('v');
                    if(videoId) embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (url.includes('youtube.com/watch?v=') || url.includes('youtu.be/')) {
                    const videoId = url.includes('youtu.be/') 
                        ? url.split('youtu.be/')[1].split('?')[0] 
                        : new URL(url).searchParams.get('v');
                    if(videoId) embedUrl = `https://www.youtube.com/embed/${videoId}`;
                }

                if (embedUrl) {
                    musicPlayerContainer.innerHTML = `
                        <iframe style="border-radius:12px" src="${embedUrl}" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                        <button id="reset-music-btn" class="mt-2 w-full bg-slate-600 hover:bg-slate-700 p-2 rounded-lg font-semibold text-sm">Change Music</button>
                    `;
                    document.getElementById('reset-music-btn').addEventListener('click', () => {
                         musicPlayerContainer.innerHTML = `
                            <div class="flex gap-2">
                                <input type="text" id="music-url-input" class="styled-input w-full px-3 py-2 rounded-lg text-sm" placeholder="Paste music URL...">
                                <button id="load-music-btn" class="accent-bg accent-bg-hover transition-colors px-4 py-2 rounded-lg font-semibold"><i class="ph ph-arrow-right"></i></button>
                            </div>`;
                        setupMusicWidget();
                    });
                } else {
                    musicUrlInput.value = 'Invalid URL';
                    setTimeout(() => { musicUrlInput.value = ''; }, 2000);
                }
            }
            
            // --- BG CHANGER BUTTON LOGIC ---
            document.getElementById('bg-upload-input').addEventListener('change', (e) => { 
                const file = e.target.files[0]; 
                if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = (event) => { 
                    const imageDataUrl = event.target.result; 
                    settings.theme = imageDataUrl; 
                    localStorage.setItem('studi-theme', imageDataUrl); 
                    applyTheme(); 
                }; 
                reader.readAsDataURL(file); 
            });
            document.getElementById('reset-bg-btn').addEventListener('click', () => {
                settings.theme = 'default-image';
                localStorage.setItem('studi-theme', 'default-image');
                applyTheme();
            });


            // --- INITIALIZE ---
            setupMusicWidget();
            applySettings();
        });
    </script>
</body>
</html>
